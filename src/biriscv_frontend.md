# Модуль biriscv_frontend

Модуль представляет собой фронтенд 32-битного RISC-V процессора, отвечающий за:
- Предсказание переходов
- Выборку инструкций из кэша
- Предварительное декодирование инструкций
- Формирование конвейера инструкций для двух потоков выполнения

## Параметры

| Параметр | Описание |
|----------|----------|
| SUPPORT_BRANCH_PREDICTION | Включение предсказания переходов |
| SUPPORT_MULDIV | Поддержка инструкций умножения/деления |
| SUPPORT_MMU | Поддержка MMU |
| EXTRA_DECODE_STAGE | Добавление дополнительной стадии декодирования |
| NUM_BTB_ENTRIES | Число записей в Branch Target Buffer |
| NUM_BTB_ENTRIES_W | Ширина адреса BTB |
| NUM_BHT_ENTRIES | Число записей в Branch History Table |
| NUM_BHT_ENTRIES_W | Ширина адреса BHT |
| RAS_ENABLE | Включение стека возвратов |
| GSHARE_ENABLE | Включение схемы предсказания Gshare |
| BHT_ENABLE | Включение истории переходов |
| NUM_RAS_ENTRIES | Глубина стека возвратов |
| NUM_RAS_ENTRIES_W | Ширина адреса RAS |

## Входы и выходы

### Входные сигналы

| Сигнал | Описание |
|--------|----------|
| clk_i | Тактовый сигнал |
| rst_i | Сигнал сброса |
| icache_accept_i | Подтверждение приема запроса кэшем инструкций |
| icache_valid_i | Действительные данные из кэша инструкций |
| icache_error_i | Ошибка доступа к кэшу инструкций |
| icache_inst_i[63:0] | Считанные инструкции (2x32-bit) |
| icache_page_fault_i | Ошибка страницы MMU |
| fetch0_accept_i | Подтверждение приема 0-го потока |
| fetch1_accept_i | Подтверждение приема 1-го потока |
| fetch_invalidate_i | Сигнал инвалидации конвейера |
| branch_request_i | Запрос на обработку перехода |
| branch_pc_i[31:0] | Адрес перехода |
| branch_priv_i[1:0] | Привилегированный режим |
| branch_info_* | Информация о выполненных переходах |

### Выходные сигналы

| Сигнал | Описание |
|--------|----------|
| icache_rd_o | Сигнал чтения кэша инструкций |
| icache_flush_o | Сброс кэша инструкций |
| icache_invalidate_o | Инвалидация кэша инструкций |
| icache_pc_o[31:0] | Адрес запрашиваемой инструкции |
| icache_priv_o[1:0] | Привилегированный режим для запроса |
| fetch0_*_o | Выходные сигналы для 0-го потока (инструкция, PC, флаги) |
| fetch1_*_o | Выходные сигналы для 1-го потока (инструкция, PC, флаги) |

## Подключенные модули

В данном модуле подключено три сабмодуля:

### Модуль biriscv_npc

Исходный код модуля представлен в [biriscv_npc.v](/src/core/biriscv_npc.v)

#### Назначение
Модуль управления потоком команд (Next PC) в процессоре RISC-V, отвечающий за:
- Определение адреса следующей исполняемой команды
- Реализацию механизмов предсказания ветвлений
- Оптимизацию работы конвейера за счет уменьшения потерь на ветвлениях

#### Ключевые особенности
1. **Гибкая архитектура**:
   - Настраиваемые размеры BTB (32 записи), BHT (512 записей) и RAS (8 уровней)
   - Поддержка различных алгоритмов предсказания
   - Возможность полного отключения предсказания

2. **Компоненты предсказания**:
   - Branch Target Buffer для хранения целей переходов
   - Return Address Stack для обработки call/ret
   - Branch History Table для статистического предсказания

3. **Эффективность**:
   - Минимизация penalty при ошибочном предсказании
   - Поддержка спекулятивного исполнения
   - Адаптивные алгоритмы замены записей

### Основные функции

1. **Предсказание адресов**:
   - Расчет следующего PC для последовательных команд
   - Определение целей условных/безусловных переходов
   - Обработка call/ret инструкций через RAS

2. **Обучение предсказателя**:
   - Обновление BTB при обнаружении новых ветвлений
   - Корректировка BHT на основе фактических переходов
   - Управление состоянием RAS

3. **Интеграция с конвейером**:
   - Генерация сигналов принятия/отклонения ветвлений
   - Обработка недействительных предсказаний
   - Синхронизация с fetch-стадией

### Модуль biriscv_decode

Исходный код модуля представлен в [biriscv_decode.v](/src/core/biriscv_decode.v)

#### Назначение

Блок декодирования инструкций в процессоре RISC-V, выполняющий:
- Разбор и декодирование поступающих инструкций
- Классификацию инструкций по типам выполнения
- Формирование управляющих сигналов для конвейера

#### Ключевые особенности

1. **Гибкая архитектура**:
   - Поддержка двух вариантов задержки (1 или 2 такта)
   - Конфигурируемая поддержка умножения/деления
   - Обработка 32-битных и парных инструкций

2. **Компоненты обработки**:
   - Декодеры инструкций для каждого слота
   - Буфер FIFO для хранения и синхронизации
   - Обработка исключений и ошибок

3. **Эффективность**:
   - Поддержка dual-issue (2 инструкции за такт)
   - Минимизация задержек декодирования
   - Интеграция с системой предсказания ветвлений

### Основные функции

1. **Декодирование инструкций**:
   - Определение типа операции (ALU, LSU, Branch и др.)
   - Выявление специальных инструкций (CSR, MUL/DIV)
   - Проверка валидности инструкций

2. **Управление потоком**:
   - Обработка прерываний и исключений
   - Реакция на неправильные предсказания ветвлений
   - Синхронизация с fetch-стадией

3. **Распределение по исполнительным блокам**:
   - Формирование сигналов для ALU, LSU, MUL/DIV
   - Указание наличия результата
   - Передача информации о PC для отладки

### Модуль biriscv_fetch

Исходный код модуля представлен в [biriscv_fetch.v](/src/core/biriscv_fetch.v)

#### Назначение

Блок выборки инструкций, выполняющий:
- Управление процессом загрузки инструкций из кэша
- Обработку переходов и изменение потока выполнения
- Синхронизацию с конвейером процессора

#### Ключевые особенности

1. **Гибкая архитектура**:
   - Поддержка работы с MMU
   - Буферизация запросов и ответов
   - Обработка ошибок доступа

2. **Управление потоком**:
   - Реакция на переходы
   - Поддержка привилегированных режимов
   - Обработка инвалидации кэша

3. **Эффективность**:
   - Механизм skid buffer для минимизации простоев
   - Конвейерная обработка запросов
   - Интеграция с системой предсказания

#### Основные функции

1. **Управление кэшем инструкций**:
   - Формирование запросов на чтение
   - Обработка подтверждений и ошибок
   - Инвалидация кэша по требованию

2. **Обработка переходов**:
   - Приоритизация запросов на переход
   - Буферизация адресов переходов
   - Синхронизация с NPC (Next PC) блоком

3. **Синхронизация данных**:
   - Передача инструкций в декодер
   - Учет предсказаний ветвлений
   - Обработка back-pressure от конвейера