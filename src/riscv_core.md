# Модуль riscv_core

Модуль представляет собой реализацию процессора RISC-V с поддержкой:

1. Конвейерной обработки команд
2. Кэширования инструкций и данных
3. Предсказания переходов
4. Привилегированных режимов
5. MMU

## Параметры

| Параметр | Описание |
|----------|----------|
| SUPPORT_BRANCH_PREDICTION | Включение предсказания переходов |
| SUPPORT_MULDIV | Поддержка умножения/деления |
| SUPPORT_SUPER | Поддержка привилегированных режимов |
| SUPPORT_MMU | Поддержка MMU |
| SUPPORT_DUAL_ISSUE | Поддержка двухпоточной выдачи |
| SUPPORT_LOAD_BYPASS | Обход загрузки |
| SUPPORT_MUL_BYPASS | Обход умножения |
| SUPPORT_REGFILE_XILINX | Использование регистрового файла Xilinx |
| EXTRA_DECODE_STAGE | Доп. стадия декодирования |
| MEM_CACHE_ADDR_MIN | Мин. адрес кэшируемой памяти |
| MEM_CACHE_ADDR_MAX | Макс. адрес кэшируемой памяти |
| NUM_BTB_ENTRIES | Число записей в BTB |
| NUM_BHT_ENTRIES | Число записей в BHT |
| RAS_ENABLE | Включение стека возвратов |
| GSHARE_ENABLE | Включение схемы Gshare |
| BHT_ENABLE | Включение истории переходов |
| NUM_RAS_ENTRIES | Глубина стека возвратов |

## Входы и выходы

| Порт | Описание |
|------|----------|
| **Входные сигналы** | |
| clk_i | Тактовый сигнал |
| rst_i | Сигнал сброса |
| mem_d_data_rd_i | Данные чтения из памяти данных |
| mem_d_accept_i | Подтверждение приема запроса данных |
| mem_d_ack_i | Подтверждение выполнения запроса |
| mem_d_error_i | Ошибка доступа к данным |
| mem_d_resp_tag_i | Тег ответа данных |
| mem_i_accept_i | Подтверждение приема запроса инструкций |
| mem_i_valid_i | Действительные данные инструкций |
| mem_i_error_i | Ошибка доступа к инструкциям |
| mem_i_inst_i | Инструкции из памяти |
| intr_i | Вход прерывания |
| reset_vector_i | Вектор сброса |
| cpu_id_i | Идентификатор CPU |
| **Выходные сигналы** | |
| mem_d_addr_o | Адрес данных |
| mem_d_data_wr_o | Данные для записи |
| mem_d_rd_o | Сигнал чтения данных |
| mem_d_wr_o | Сигналы записи данных |
| mem_d_cacheable_o | Флаг кэшируемости |
| mem_d_req_tag_o | Тег запроса данных |
| mem_d_invalidate_o | Инвалидация кэша |
| mem_d_writeback_o | Запись обратно |
| mem_d_flush_o | Сброс кэша |
| mem_i_rd_o | Сигнал чтения инструкций |
| mem_i_flush_o | Сброс кэша инструкций |
| mem_i_invalidate_o | Инвалидация кэша инструкций |
| mem_i_pc_o | Адрес инструкции |

## Подключенные модули

Модуль состоит из шести подмодулей:

### Модуль biriscv_frontend

Описание модуля представлено в документе[biriscv_frontend.md](/description/biriscv_frontend.md)

Исходный код модуля представлен в [biriscv_frontend.v](/src/core/biriscv_frontend.v)

Фронтенд 32-битного RISC-V процессора, отвечающий за:
- Предсказание переходов
- Выбор инструкций из памяти
- Предварительнок декодирование инструкций
- Формирование конвейера инструкций

#### Ключевые особенности

- Поддержка двухпоточного исполнения
- Конфигурируемые параметры предсказания переходов
  - Branch Target Buffer
  - Branch History Table
  - Return Address Stack
- Поддержка MMU
- Раздельные интерфейсы для кэша инструкций и декодера
- Обнаружение ошибок доступа к памяти

### Модуль biriscv_mmu

Исходный код модуля представлен в [biriscv_mmu.v](/src/core/biriscv_mmu.v)

#### Назначение

Блок управления виртуальной памятью для RISC-V процессора, выполняющий:
- Конвертацию виртуальных адресов в физические
- Контроль прав доступа к памяти
- Управление TLB
- Обработку страничных исключений

#### Ключевые особенности

- Поддержка страничной адресация RISC-V
- Двухуровневая таблица страниц (4KB / 4MB)
- Раздельные TLB для инструкций и данных
- Контроль прав доступа:
  - Чтение/запись/исполнение
  - Пользовательский и привилигированный режимы
  - Флаги SUM и MXR для гибкого контроля
- Поддержка аппаратной инвалидации TLB

#### Основные функции

1. **Обработка запросов на выборку инструкций**:
   - Проверка прав исполнения
   - Контроль доступа супервизора к пользовательским страницам

2. **Обработка запросов к данным**:
   - Проверка прав чтения и записи
   - Учет флага MXR - разрешение исполнения при чтении
   - Учет флага SUM - разрешение супервизору доступа к пользовательским страницам

3. **Page Table Walker**:
   - Аппаратный обход таблиц страниц
   - Поддержка двухуровневой адресации
   - Обработка ошибок

4. **Интерфейс с кэшем**:
   - Генерация физических адресов
   - Управление кэшируемостью памяти
   - Обработка исключений доступа

### Модуль biriscv_lsu

Исходный код модуля представлен в [biriscv_lsu.v](/src/core/biriscv_lsu.v)

#### Назначение

Блок загрузки и сохранения для процессора, выполняющий:
- Обработку операций загрузки и сохранения
- Управление доступом к памяти данных
- Обработку неполных адресов
- Генерацию исключений при ошибках доступа

#### Ключевые особенности

- Поддержка операций разной ширины (8/16/32 бита)
- Обработка знаковых/беззнаковых загрузок
- Поддержка кэшируемых и некэшируемых областей памяти
- Управление кэшем данных
- Конвейерная обработка запросов

#### Основные функции

1. **Декодирование инструкций**:
   - Определение типа операции
   - Вычисление эффективного адреса
   - Проверка выравнивания адреса

2. **Формирование запросов к памяти**:
   - Генерация сигналов чтения/записи
   - Маскировка байтов для операций разной ширины
   - Управление кэшэм

3. **Обработка ответов**:
   - Коррекция данных при загрузке
   - Обработка ошибок
   - Формирование результата для блока writeback

4. **Управление конвейером**:
   - Генерация сигналов остановки
   - Отслеживание невыполненных запросов

### Модуль biriscv_csr

Исходный код модуля представлен в [biriscv_csr.v](/src/core/biriscv_csr.v)

#### Назначение

Блок управления Control and Status Registers, отвечающий за:
- Обработку операций с CSR-регистрами
- Управление привилегированными режимами
- Обработку исключений и прерываний
- Управление MMU и кэшем
- Генерацию сигналов перехода

#### Ключевые особенности

- Поддержка стандартных CSR RISC-V
- Обработка инструкций: ECALL/EBREAK/ERET, FENCE, WFI
- Управление привилегиями доступа к CSR
- Интеграция с системой прерываний
- Поддержка супервизорного режима

#### Основные функции

1. **Декодирование CSR-инструкций**:
   - CSRRW/CSRRS/CSRRC и их immediate-варианты
   - Проверка прав доступа к CSR

2. **Управление состоянием процессора**:
   - Обработка исключений и прерываний
   - Управление привилегированными режимами
   - Обработка инструкций синхронизации

3. **Интеграция с конвейером**:
   - Генерация сигналов исключений
   - Управление переходами
   - Взаимодействие с MMU

4. **Системные операции**:
   - Сброс процессора
   - Управление таймерами и внешними прерываниями

### Модуль biriscv_multiplier

Исходный код модуля представлен в [biriscv_multiplier.v](/src/core/biriscv_multiplier.v)

#### Назначение

Блок умножения, выполняющий:
- Целочисленное умножение 32-битных операндов
- Обработку знаковых и беззнаковых операций
- Конвейерную обработку с настраиваемой глубиной

#### Ключевые особенности

- Поддержка всех типов умножения RISC-V:
  - MUL
  - MULH
  - MULHU
  - MULHSU
- Конфигурируемая задержка
- Интеграция с конвейером процессора

#### Основные функции

1. **Декодирование инструкций**:
   - Определение типа операции умножения
   - Подготовка операндов

2. **Выполнение умножения**:
   - 32×32-битное умножение с получением 64-битного результата
   - Выбор нужной части результата

3. **Конвейерная обработка**:
   - Регистры для промежуточного хранения результатов
   - Поддержка сигнала остановки конвейера

### Модуль biriscv_divider

Исходный код модуля представлен в [biriscv_divider.v](/src/core/biriscv_divider.v)

#### Назначение

Блок деления, выполняющий:

- Деление и вычисление остатка для 32-битных операндов
- Обработку знаковых и беззнаковых операций
- Пошаговое вычисление за несколько тактов

#### Ключевые особенности

- Поддержка всех операций деления RISC-V:
  - DIV (знаковое деление)
  - DIVU (беззнаковое деление)  
  - REM (знаковый остаток)
  - REMU (беззнаковый остаток)
- Последовательный алгоритм деления
- Оптимизация повторных операций с теми же операндами
- Коррекция знака результата

#### Основные функции

1. **Декодирование инструкций**:
   - Определение типа операции (DIV/DIVU/REM/REMU)
   - Подготовка операндов

2. **Выполнение деления**:
   - Последовательное вычитание со сдвигом
   - Формирование частного и остатка
   - Коррекция знака результата

3. **Управление процессом**:
   - Контроль состояния вычисления
   - Определение завершения операции
   - Формирование выходных данных для блока writeback

### Модуль biriscv_issue

Исходный код модуля представлен в [biriscv_issue.v](/src/core/biriscv_issue.v)

#### Назначение

Блок управления конвейером и диспетчеризации инструкций, выполняющий:
- Управление порядком выполнения инструкций
- Распределение инструкций по исполнительным блокам
- Обработку зависимостей данных
- Управление обходными путями
- Контроль состояния конвейера

#### Ключевые особенности

- Поддержка двухканального вызова инструкций
- Управление 5 основными исполнительными блоками:
  - ALU
  - LSU
  - MUL
  - DIV
  - CSR
- Динамическое планирование с учетом зависимостей
- Поддержка прерываний и исключений

#### Основные функции

1. **Декодирование и диспетчеризация**:
   - Анализ готовности инструкций
   - Распределение по исполнительным блокам
   - Управление двухканальным выпуском

2. **Управление зависимостями**:
   - Scoreboarding для отслеживания занятости регистров
   - Обходные пути для результатов операций
   - Обработка RAW/WAW зависимостей

3. **Управление конвейером**:
   - Обработка остановок и сбросов
   - Управление длительными операциями
   - Координация работы с блоками CSR и LSU

4. **Обработка переходов**:
   - Управление предсказанием переходов
   - Обработка ошибочных предсказаний
   - Обновление информации о ветвлениях

### Модуль biriscv_exec

Исходный код модуля представлен в [biriscv_exec.v](/src/core/biriscv_exec.v)

#### Назначение

Основной блок исполнения команд в процессоре RISC-V, выполняющий:
- Арифметико-логические операции
- Обработку переходов и ветвлений
- Вычисление адресов для операций загрузки/сохранения
- Формирование результатов для writeback

#### Ключевые функции

1. **Обработка ALU операций**:
   - Арифметические (ADD, SUB)
   - Логические (AND, OR, XOR)
   - Сдвиги (SLL, SRL, SRA)
   - Сравнения (SLT, SLTU)

2. **Управление потоком команд**:
   - Безусловные переходы (JAL, JALR)
   - Условные ветвления (BEQ, BNE, BLT, BGE)
   - Определение признаков call/ret

3. **Генерация констант**:
   - Формирование immediate-значений
   - Обработка LUI/AUIPC инструкций

4. **Интеграция с конвейером**:
   - Управление сигналами ветвления
   - Передача результатов в writeback
   - Обработка сигналов остановки