# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  .gitlab-ci.yml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stages:
  - build

variables:
  # ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³, Ğ³Ğ´Ğµ build_docs.py ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ fragment-Ñ‹
  BUILD_DIR: build

# ---------- Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° PDF ----------
build-pdf:
  stage: build

  # ğŸ‘‰ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ·, ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ· Dockerfile Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ñ€ĞµĞ¿Ğ¾
  #    GitLab ÑĞ°Ğ¼ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ ĞµĞ³Ğ¾ Ğ¸ Ğ·Ğ°ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ (ĞµÑĞ»Ğ¸ shared runner Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½
  #    Ğ½Ğ° Docker + "Auto DevOps / Build â†’ Enable custom build").
  image: $CI_REGISTRY_IMAGE:latest

  #  Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚Ğµ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ registry:
  # image: registry.gitlab.com/<group>/<project>/latex-builder:latest

  before_script:
    # ĞĞ°Ğ±Ğ¾Ñ€ python-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ½ÑƒĞ¶Ğ½Ñ‹ (requirements.txt)
    # pip install --no-cache-dir -r requirements.txt || true
    - echo "Using image $CI_REGISTRY_IMAGE"

  script:
    - python3 build_docs.py build      # 1) .md â†’ .tex   2) latexmk â†’ PDF
    - ls -lh main.pdf                  # ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´

  artifacts:
    # ĞÑ‚Ğ´Ğ°Ñ‘Ğ¼ PDF ĞºĞ°Ğº job-Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
    paths:
      - main.pdf
    expire_in: 1 week

  rules:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Markdown, LaTeX Ğ¸Ğ»Ğ¸ CI-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
    - changes:
        - "SRC/**/*.md"
        - "*.tex"
        - ".gitlab-ci.yml"
        - "build_docs.py"
      when: on_success
